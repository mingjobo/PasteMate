<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PureText Extension Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-error { color: #f48771; }
        .log-warn { color: #dcdcaa; }
        .log-info { color: #9cdcfe; }
        .log-debug { color: #b5cea8; }
    </style>
</head>
<body>
    <h1>ğŸ§ª PureText Extension æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>æµè§ˆå™¨ä¿¡æ¯</h2>
        <div id="browser-info"></div>
    </div>

    <div class="test-section">
        <h2>æ‰©å±•åŠ è½½æµ‹è¯•</h2>
        <button onclick="testExtensionLoad()">æµ‹è¯•æ‰©å±•åŠ è½½</button>
        <button onclick="checkContentScript()">æ£€æŸ¥Content Script</button>
        <button onclick="simulateAIResponse()">æ¨¡æ‹ŸAIå›å¤</button>
        <div id="extension-status"></div>
    </div>

    <div class="test-section">
        <h2>åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testClipboard()">æµ‹è¯•å‰ªè´´æ¿åŠŸèƒ½</button>
        <button onclick="testButtonInjection()">æµ‹è¯•æŒ‰é’®æ³¨å…¥</button>
        <div id="function-status"></div>
    </div>

    <div class="test-section">
        <h2>æ¨¡æ‹ŸAIå›å¤å†…å®¹</h2>
        <div class="segment-content-box" style="padding: 15px; background: #f9f9f9; border-radius: 8px;">
            <div class="markdown-container">
                <h3>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•AIå›å¤</h3>
                <p>è¿™æ˜¯AIç”Ÿæˆçš„å†…å®¹ï¼Œç”¨äºæµ‹è¯•æ‰©å±•åŠŸèƒ½ã€‚</p>
                <ul>
                    <li>é¡¹ç›®1</li>
                    <li>é¡¹ç›®2</li>
                    <li>é¡¹ç›®3</li>
                </ul>
                <pre><code>// ç¤ºä¾‹ä»£ç 
function test() {
    console.log("Hello World");
}</code></pre>
            </div>
        </div>
        <div id="injection-target"></div>
    </div>

    <div class="test-section">
        <h2>æ§åˆ¶å°è¾“å‡º</h2>
        <div id="console-output"></div>
    </div>

    <script>
        // ä¿å­˜åŸå§‹consoleæ–¹æ³•
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info,
            debug: console.debug
        };

        // æ‹¦æˆªconsoleè¾“å‡º
        const consoleOutput = document.getElementById('console-output');
        
        function logToPage(type, ...args) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${type.toUpperCase()}: ${args.join(' ')}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°çœŸå®æ§åˆ¶å°
            originalConsole[type](...args);
        }

        console.log = (...args) => logToPage('info', ...args);
        console.error = (...args) => logToPage('error', ...args);
        console.warn = (...args) => logToPage('warn', ...args);
        console.info = (...args) => logToPage('info', ...args);
        console.debug = (...args) => logToPage('debug', ...args);

        // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        function showBrowserInfo() {
            const info = document.getElementById('browser-info');
            const userAgent = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = '';
            
            if (userAgent.includes('Edg/')) {
                browserName = 'Microsoft Edge';
                browserVersion = userAgent.match(/Edg\/([\d.]+)/)?.[1] || '';
            } else if (userAgent.includes('Chrome/')) {
                browserName = 'Google Chrome';
                browserVersion = userAgent.match(/Chrome\/([\d.]+)/)?.[1] || '';
            } else if (userAgent.includes('Firefox/')) {
                browserName = 'Mozilla Firefox';
                browserVersion = userAgent.match(/Firefox\/([\d.]+)/)?.[1] || '';
            }
            
            info.innerHTML = `
                <div class="status info">
                    <strong>æµè§ˆå™¨:</strong> ${browserName} ${browserVersion}<br>
                    <strong>User Agent:</strong> ${userAgent}<br>
                    <strong>å¹³å°:</strong> ${navigator.platform}<br>
                    <strong>è¯­è¨€:</strong> ${navigator.language}
                </div>
            `;
        }

        // æµ‹è¯•æ‰©å±•åŠ è½½
        function testExtensionLoad() {
            const status = document.getElementById('extension-status');
            console.log('å¼€å§‹æµ‹è¯•æ‰©å±•åŠ è½½...');
            
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ‰©å±•æ³¨å…¥çš„å…¨å±€å˜é‡æˆ–ç±»
            const checks = [
                { name: 'PURETEXT_DEBUG_LEVEL', exists: typeof window.PURETEXT_DEBUG_LEVEL !== 'undefined' },
                { name: 'ClipboardManager', exists: typeof window.ClipboardManager !== 'undefined' },
                { name: 'PureTextæŒ‰é’®', exists: document.querySelector('.puretext-copy-btn') !== null }
            ];
            
            let html = '<h3>æ‰©å±•åŠ è½½æ£€æŸ¥ç»“æœ:</h3>';
            checks.forEach(check => {
                const statusClass = check.exists ? 'success' : 'error';
                const statusText = check.exists ? 'âœ… å·²åŠ è½½' : 'âŒ æœªæ£€æµ‹åˆ°';
                html += `<div class="status ${statusClass}">${check.name}: ${statusText}</div>`;
                console.log(`${check.name}: ${statusText}`);
            });
            
            status.innerHTML = html;
        }

        // æ£€æŸ¥Content Script
        function checkContentScript() {
            const status = document.getElementById('extension-status');
            console.log('æ£€æŸ¥Content Script...');
            
            // å°è¯•è§¦å‘æ‰©å±•çš„è°ƒè¯•æ—¥å¿—
            if (typeof window.PURETEXT_DEBUG_LEVEL !== 'undefined') {
                window.PURETEXT_DEBUG_LEVEL = 3; // è®¾ç½®ä¸ºDEBUGçº§åˆ«
                console.log('å·²è®¾ç½®è°ƒè¯•çº§åˆ«ä¸ºDEBUG');
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ³¨å…¥çš„å…ƒç´ 
            const injectedElements = document.querySelectorAll('[class*="puretext"]');
            
            status.innerHTML += `
                <div class="status ${injectedElements.length > 0 ? 'success' : 'info'}">
                    å‘ç° ${injectedElements.length} ä¸ªæ‰©å±•æ³¨å…¥çš„å…ƒç´ 
                </div>
            `;
            
            if (injectedElements.length > 0) {
                console.log('æ‰¾åˆ°æ³¨å…¥å…ƒç´ :', injectedElements);
            }
        }

        // æ¨¡æ‹ŸAIå›å¤
        function simulateAIResponse() {
            console.log('åˆ›å»ºæ¨¡æ‹ŸAIå›å¤...');
            const target = document.getElementById('injection-target');
            
            // æ¨¡æ‹ŸChatGPTæ ·å¼çš„å›å¤
            const mockResponse = document.createElement('div');
            mockResponse.className = 'message-content';
            mockResponse.innerHTML = `
                <div style="padding: 20px; background: white; border: 1px solid #e5e5e5; border-radius: 8px; margin: 10px 0;">
                    <p><strong>æ¨¡æ‹Ÿçš„AIå›å¤å†…å®¹</strong></p>
                    <p>è¿™æ˜¯ä¸€æ®µæ¨¡æ‹Ÿçš„AIå›å¤æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•æ‰©å±•çš„æŒ‰é’®æ³¨å…¥åŠŸèƒ½ã€‚</p>
                    <pre style="background: #f4f4f4; padding: 10px; border-radius: 4px;">
function example() {
    return "æµ‹è¯•ä»£ç ";
}</pre>
                </div>
            `;
            
            target.appendChild(mockResponse);
            console.log('å·²æ·»åŠ æ¨¡æ‹ŸAIå›å¤ï¼Œç­‰å¾…æ‰©å±•æ³¨å…¥æŒ‰é’®...');
            
            // è§¦å‘DOMå˜åŒ–ï¼Œè®©æ‰©å±•çš„MutationObserveræ£€æµ‹åˆ°
            setTimeout(() => {
                const event = new Event('DOMNodeInserted', { bubbles: true });
                mockResponse.dispatchEvent(event);
            }, 100);
        }

        // æµ‹è¯•å‰ªè´´æ¿åŠŸèƒ½
        async function testClipboard() {
            const status = document.getElementById('function-status');
            console.log('æµ‹è¯•å‰ªè´´æ¿åŠŸèƒ½...');
            
            try {
                // æµ‹è¯•å‰ªè´´æ¿æƒé™
                const permission = await navigator.permissions.query({ name: 'clipboard-write' });
                console.log('å‰ªè´´æ¿æƒé™çŠ¶æ€:', permission.state);
                
                // å°è¯•å†™å…¥å‰ªè´´æ¿
                const testText = 'æµ‹è¯•æ–‡æœ¬ - ' + new Date().toLocaleTimeString();
                await navigator.clipboard.writeText(testText);
                console.log('æˆåŠŸå†™å…¥å‰ªè´´æ¿:', testText);
                
                status.innerHTML = `
                    <div class="status success">
                        âœ… å‰ªè´´æ¿åŠŸèƒ½æ­£å¸¸<br>
                        æƒé™çŠ¶æ€: ${permission.state}<br>
                        å·²å†™å…¥: ${testText}
                    </div>
                `;
            } catch (error) {
                console.error('å‰ªè´´æ¿æµ‹è¯•å¤±è´¥:', error);
                status.innerHTML = `
                    <div class="status error">
                        âŒ å‰ªè´´æ¿æµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•æŒ‰é’®æ³¨å…¥
        function testButtonInjection() {
            const status = document.getElementById('function-status');
            console.log('æµ‹è¯•æŒ‰é’®æ³¨å…¥åŠŸèƒ½...');
            
            // æŸ¥æ‰¾æ‰€æœ‰æ³¨å…¥çš„æŒ‰é’®
            const buttons = document.querySelectorAll('.puretext-copy-btn, .puretext-button-container, .puretext-button-group');
            
            if (buttons.length > 0) {
                console.log(`æ‰¾åˆ° ${buttons.length} ä¸ªæ³¨å…¥çš„æŒ‰é’®`);
                status.innerHTML = `
                    <div class="status success">
                        âœ… æ‰¾åˆ° ${buttons.length} ä¸ªæ³¨å…¥çš„æŒ‰é’®
                    </div>
                `;
                
                // å°è¯•ç‚¹å‡»ç¬¬ä¸€ä¸ªæŒ‰é’®
                if (buttons[0]) {
                    console.log('å°è¯•è§¦å‘æŒ‰é’®ç‚¹å‡»...');
                    buttons[0].click();
                }
            } else {
                console.log('æœªæ‰¾åˆ°æ³¨å…¥çš„æŒ‰é’®');
                status.innerHTML = `
                    <div class="status error">
                        âŒ æœªæ‰¾åˆ°æ³¨å…¥çš„æŒ‰é’®<br>
                        è¯·å…ˆè¿è¡Œ"æ¨¡æ‹ŸAIå›å¤"æ¥åˆ›å»ºæµ‹è¯•å†…å®¹
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        window.addEventListener('DOMContentLoaded', () => {
            showBrowserInfo();
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('è¯·ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®æ¥æ£€æŸ¥æ‰©å±•åŠŸèƒ½');
            
            // å»¶è¿Ÿæ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½
            setTimeout(() => {
                if (typeof window.PURETEXT_DEBUG_LEVEL === 'undefined') {
                    console.warn('æ‰©å±•å¯èƒ½æœªåŠ è½½ï¼Œè¯·ç¡®ä¿ï¼š');
                    console.warn('1. æ‰©å±•å·²åœ¨æµè§ˆå™¨ä¸­å¯ç”¨');
                    console.warn('2. åœ¨manifest.jsonä¸­æ·»åŠ äº† file://*/* åˆ°content_scriptsçš„matches');
                    console.warn('3. åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }, 2000);
        });
    </script>
</body>
</html>