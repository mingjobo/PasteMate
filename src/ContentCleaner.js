/**
 * å†…å®¹æ¸…ç†å™¨
 * è´Ÿè´£ç§»é™¤DOMå…ƒç´ ä¸­ä¸éœ€è¦çš„å†…å®¹ï¼Œå¦‚æŒ‰é’®ã€AIå£°æ˜ã€æ¨èé—®é¢˜ç­‰
 */
class ContentCleaner {
    constructor() {
        // æ¸…ç†è§„åˆ™æ˜ å°„ï¼Œå¯ä»¥æ ¹æ®ç½‘ç«™å®šåˆ¶
        this.cleaningRules = new Map();
        
        // æ¸…ç†åœºæ™¯æ ‡è¯†
        this.cleaningForCopy = false;

        // åˆå§‹åŒ–é»˜è®¤æ¸…ç†è§„åˆ™
        this.initializeDefaultRules();
    }

    /**
     * æ¸…ç†DOMå…ƒç´ ä¸­çš„ä¸éœ€è¦å†…å®¹
     * @param {HTMLElement} element - è¦æ¸…ç†çš„DOMå…ƒç´ 
     * @param {string} hostname - ç½‘ç«™åŸŸå
     * @param {boolean} isCopyScenario - æ˜¯å¦æ˜¯å¤åˆ¶åœºæ™¯
     * @returns {Promise<void>}
     */
    async clean(element, hostname = window.location.hostname, isCopyScenario = false) {
        try {
            this.cleaningForCopy = isCopyScenario;
            console.debug(`[ContentCleaner] Starting cleanup for ${hostname}, copy scenario: ${isCopyScenario}`);

            // 1. ç§»é™¤å¤åˆ¶æŒ‰é’®
            this.removeButtons(element);

            // 2. ç§»é™¤AIå£°æ˜
            this.removeAIStatements(element);

            // 3. ç§»é™¤æ¨èé—®é¢˜
            this.removeRecommendedQuestions(element, hostname);

            // 4. ç§»é™¤å¯¼èˆªå’Œèœå•å…ƒç´ 
            this.removeNavigationElements(element);

            // 5. åº”ç”¨ç½‘ç«™ç‰¹å®šçš„æ¸…ç†è§„åˆ™
            await this.applyCustomRules(element, hostname);

            // 6. æ¸…ç†ç©ºå…ƒç´ 
            this.removeEmptyElements(element);

            console.debug(`[ContentCleaner] Cleanup completed for ${hostname}`);

        } catch (error) {
            console.error(`[ContentCleaner] Cleanup failed for ${hostname}:`, error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…é˜»å¡æ ¼å¼åŒ–æµç¨‹
        }
    }

    /**
     * ç§»é™¤æŒ‰é’®å…ƒç´ 
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    removeButtons(element) {
        console.debug('[ContentCleaner] Removing buttons');

        // ç§»é™¤å¤åˆ¶æŒ‰é’®å®¹å™¨
        element.querySelectorAll('.puretext-copy-btn, .puretext-button-container').forEach(btn => {
            console.debug('[ContentCleaner] Removing PureText button:', btn.textContent?.trim());
            btn.remove();
        });

        // ç§»é™¤å¸¸è§çš„æ“ä½œæŒ‰é’®
        const buttonSelectors = [
            'button',
            '[role="button"]',
            '.btn',
            '.button',
            '[onclick]',
            'a[href="#"]',
            '.action',
            '.menu'
        ];

        buttonSelectors.forEach(selector => {
            element.querySelectorAll(selector).forEach(button => {
                const text = button.textContent?.trim();

                // åªç§»é™¤ç‰¹å®šçš„æ“ä½œæŒ‰é’®ï¼Œé¿å…è¯¯åˆ é‡è¦å†…å®¹
                if (text && this.isOperationButton(text)) {
                    console.debug('[ContentCleaner] Removing operation button:', text);
                    button.remove();
                }
            });
        });
    }

    /**
     * åˆ¤æ–­æ˜¯å¦æ˜¯æ“ä½œæŒ‰é’®
     * @param {string} text - æŒ‰é’®æ–‡æœ¬
     * @returns {boolean} æ˜¯å¦æ˜¯æ“ä½œæŒ‰é’®
     */
    isOperationButton(text) {
        const operationPatterns = [
            /^(å¤åˆ¶|é‡è¯•|åˆ†äº«|ç¼–è¾‘|æœç´¢|æœç´¢ä¸€ä¸‹|ç‚¹èµ|è¸©|æ”¶è—|åˆ é™¤|ä¸¾æŠ¥|æ›´å¤š)$/,
            /^(Copy|Retry|Share|Edit|Search|Like|Dislike|Save|Delete|Report|More)$/i,
            /^(ã‚³ãƒ”ãƒ¼|å†è©¦è¡Œ|å…±æœ‰|ç·¨é›†|æ¤œç´¢|ã„ã„ã­|ä¿å­˜|å‰Šé™¤|å ±å‘Š)$/,
            // å›¾æ ‡æŒ‰é’®ï¼ˆåªåŒ…å«ç¬¦å·ï¼‰
            /^[ğŸ‘ğŸ‘â¤ï¸ğŸ’¾ğŸ”—ğŸ“‹ğŸ”„âœï¸ğŸ—‘ï¸âš™ï¸]$/,
            // ç©ºç™½æˆ–åªæœ‰ç©ºæ ¼çš„æŒ‰é’®
            /^\s*$/
        ];

        return operationPatterns.some(pattern => pattern.test(text));
    }

    /**
     * ç§»é™¤AIç”Ÿæˆå£°æ˜
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    removeAIStatements(element) {
        console.debug('[ContentCleaner] Removing AI statements');

        const aiStatementPatterns = [
            /æœ¬å›ç­”ç”±\s*AI\s*ç”Ÿæˆ.*å†…å®¹ä»…ä¾›å‚è€ƒ/,
            /This response was generated by AI.*for reference only/i,
            /AI\s*ç”Ÿæˆçš„å›ç­”/,
            /Generated by AI/i,
            /äººå·¥æ™ºèƒ½ç”Ÿæˆ/,
            /æœºå™¨ç”Ÿæˆå†…å®¹/,
            /AIåŠ©æ‰‹å›å¤/,
            /æ™ºèƒ½åŠ©æ‰‹ç”Ÿæˆ/
        ];

        // æŸ¥æ‰¾åŒ…å«AIå£°æ˜çš„å…ƒç´ 
        const allElements = Array.from(element.querySelectorAll('*'));

        allElements.forEach(el => {
            const text = el.textContent?.trim();
            if (text && aiStatementPatterns.some(pattern => pattern.test(text))) {
                console.debug('[ContentCleaner] Removing AI statement:', text.substring(0, 50) + '...');
                el.remove();
            }
        });
    }

    /**
     * ç§»é™¤æ¨èé—®é¢˜
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @param {string} hostname - ç½‘ç«™åŸŸå
     */
    removeRecommendedQuestions(element, hostname) {
        console.debug('[ContentCleaner] Removing recommended questions');

        // 1. é€šè¿‡CSSé€‰æ‹©å™¨ç§»é™¤æ˜æ˜¾çš„æ¨èé—®é¢˜åŒºåŸŸ
        const questionSelectors = [
            '[class*="recommend"]',
            '[class*="suggest"]',
            '[class*="related"]',
            '[class*="question"]',
            '[data-testid*="question"]',
            '[data-testid*="suggest"]',
            '.follow-up',
            '.next-question'
        ];

        questionSelectors.forEach(selector => {
            element.querySelectorAll(selector).forEach(el => {
                console.debug('[ContentCleaner] Removing question container by selector:', selector);
                el.remove();
            });
        });

        // 2. åŸºäºæ–‡æœ¬æ¨¡å¼çš„æ™ºèƒ½æ¸…ç†
        this.removeQuestionsByPattern(element);

        // 3. åº”ç”¨ç½‘ç«™ç‰¹å®šçš„æ¨èé—®é¢˜æ¸…ç†è§„åˆ™
        this.applyHostnameSpecificQuestionCleaning(element, hostname);
    }

    /**
     * åŸºäºæ–‡æœ¬æ¨¡å¼ç§»é™¤æ¨èé—®é¢˜
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    removeQuestionsByPattern(element) {
        const allElements = Array.from(element.querySelectorAll('*'));

        allElements.forEach(el => {
            const text = el.textContent?.trim();
            if (text && this.isRecommendedQuestion(text)) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç‹¬ç«‹çš„é—®é¢˜å…ƒç´ ï¼ˆä¸åŒ…å«å…¶ä»–é‡è¦å†…å®¹ï¼‰
                if (this.isStandaloneQuestion(el)) {
                    console.debug('[ContentCleaner] Removing recommended question:', text.substring(0, 30) + '...');
                    el.remove();
                }
            }
        });
    }

    /**
     * åˆ¤æ–­æ–‡æœ¬æ˜¯å¦æ˜¯æ¨èé—®é¢˜
     * @param {string} text - æ–‡æœ¬å†…å®¹
     * @returns {boolean} æ˜¯å¦æ˜¯æ¨èé—®é¢˜
     */
    isRecommendedQuestion(text) {
        if (!text || text.length > 150) return false;

        const questionPatterns = [
            // ä¸­æ–‡é—®é¢˜æ¨¡å¼
            /^[^ã€‚ï¼]*[ï¼Ÿ?]$/,  // ä»¥é—®å·ç»“å°¾çš„çŸ­å¥
            /^(?:å¦‚ä½•|æ€ä¹ˆ|ä»€ä¹ˆæ˜¯|ä»€ä¹ˆå«|ä¸ºä»€ä¹ˆ|å“ªäº›|å¤šå°‘|ä½•æ—¶|åœ¨å“ª|æ˜¯å¦|èƒ½å¦|å¯ä»¥)[^ã€‚ï¼]*[ï¼Ÿ?]$/,
            /^(?:è°|å“ª|ä»€ä¹ˆ|æ€æ ·|å¤šå°‘|å‡ |ä½•)[^ã€‚ï¼]*[ï¼Ÿ?]$/,
            /[^ã€‚ï¼]*(?:å¤šä¹…|ä»€ä¹ˆæ—¶å€™|ä½•æ—¶|æ—¶é—´|æœŸé™|å‘¨æœŸ)[^ã€‚ï¼]*[ï¼Ÿ?]$/,
            /[^ã€‚ï¼]*(?:å¤šå°‘|æ¯”ä¾‹|è´¹ç”¨|æˆæœ¬|ä»·æ ¼|é‡‘é¢|æ•°é‡)[^ã€‚ï¼]*[ï¼Ÿ?]$/,
            /[^ã€‚ï¼]*(?:å¦‚æœ|å‡å¦‚|è¦æ˜¯|æƒ…å†µä¸‹|æ¡ä»¶)[^ã€‚ï¼]*[ï¼Ÿ?]$/,

            // è‹±æ–‡é—®é¢˜æ¨¡å¼
            /^(How|What|Why|When|Where|Who|Which|Can|Could|Would|Should|Is|Are|Do|Does|Did)[^.!]*\?$/i,
            /^[^.!]*\?$/,  // ä»¥é—®å·ç»“å°¾çš„è‹±æ–‡å¥å­

            // ç‰¹å®šé¢†åŸŸé—®é¢˜ï¼ˆé‡‘èã€æŠ€æœ¯ç­‰ï¼‰
            /(?:ä¿è¯é‡‘|å¼ºå¹³|æœŸè´§|äº¤æ˜“|é£é™©|åˆçº¦|å¹³ä»“|å¼€ä»“)[^ã€‚ï¼]*[ï¼Ÿ?]$/,
            /(?:API|æ¥å£|ä»£ç |å‡½æ•°|æ–¹æ³•|ç®—æ³•)[^ã€‚ï¼]*[ï¼Ÿ?]$/
        ];

        return questionPatterns.some(pattern => pattern.test(text));
    }

    /**
     * åˆ¤æ–­å…ƒç´ æ˜¯å¦æ˜¯ç‹¬ç«‹çš„é—®é¢˜å…ƒç´ 
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @returns {boolean} æ˜¯å¦æ˜¯ç‹¬ç«‹é—®é¢˜
     */
    isStandaloneQuestion(element) {
        // æ£€æŸ¥å…ƒç´ æ˜¯å¦åªåŒ…å«é—®é¢˜æ–‡æœ¬ï¼Œæ²¡æœ‰å…¶ä»–é‡è¦å†…å®¹
        const text = element.textContent?.trim();
        const children = element.children || [];

        // å¦‚æœå…ƒç´ æœ‰å¾ˆå¤šå­å…ƒç´ ï¼Œå¯èƒ½åŒ…å«é‡è¦å†…å®¹
        if (children.length > 3) {
            return false;
        }

        // å¦‚æœæ–‡æœ¬å¾ˆé•¿ï¼Œå¯èƒ½ä¸æ˜¯ç®€å•çš„æ¨èé—®é¢˜
        if (text && text.length > 100) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«éé—®é¢˜å†…å®¹
        const hasNonQuestionContent = Array.from(children).some(child => {
            const childText = child.textContent?.trim();
            return childText && !this.isRecommendedQuestion(childText);
        });

        return !hasNonQuestionContent;
    }

    /**
     * åº”ç”¨ç½‘ç«™ç‰¹å®šçš„æ¨èé—®é¢˜æ¸…ç†è§„åˆ™
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @param {string} hostname - ç½‘ç«™åŸŸå
     */
    applyHostnameSpecificQuestionCleaning(element, hostname) {
        switch (hostname) {
            case 'www.kimi.com':
                this.cleanKimiRecommendedQuestions(element);
                break;
            case 'chat.deepseek.com':
                this.cleanDeepSeekRecommendedQuestions(element);
                break;
            default:
                // é€šç”¨æ¸…ç†å·²ç»åœ¨ä¸Šé¢å®Œæˆ
                break;
        }
    }

    /**
     * æ¸…ç†Kimiç½‘ç«™çš„æ¨èé—®é¢˜
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    cleanKimiRecommendedQuestions(element) {
        // Kimiç‰¹æœ‰çš„æ¨èé—®é¢˜å®¹å™¨
        const kimiQuestionSelectors = [
            '.recommend-prompt-list',
            '.recommend-prompt',
            '.recommend-prompt-item',
            '[class*="recommend"]'
        ];

        kimiQuestionSelectors.forEach(selector => {
            element.querySelectorAll(selector).forEach(el => {
                console.debug('[ContentCleaner] Removing Kimi question container:', selector);
                el.remove();
            });
        });
    }

    /**
     * æ¸…ç†DeepSeekç½‘ç«™çš„æ¨èé—®é¢˜
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    cleanDeepSeekRecommendedQuestions(element) {
        // DeepSeekç‰¹æœ‰çš„æ¨èé—®é¢˜æ¨¡å¼
        // é€šå¸¸DeepSeekçš„æ¨èé—®é¢˜è¾ƒå°‘ï¼Œä¸»è¦ä¾èµ–é€šç”¨æ¸…ç†
    }


    /**
     * ç§»é™¤å¯¼èˆªå’Œèœå•å…ƒç´ 
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    removeNavigationElements(element) {
        console.debug('[ContentCleaner] Removing navigation elements');

        const navigationSelectors = [
            'nav',
            '.navigation',
            '.nav',
            '.menu',
            '.sidebar',
            '.header',
            '.footer',
            '.breadcrumb',
            '.pagination',
            '[role="navigation"]',
            '[role="menu"]',
            '[role="menubar"]'
        ];

        navigationSelectors.forEach(selector => {
            element.querySelectorAll(selector).forEach(el => {
                // åªç§»é™¤æ˜æ˜¾çš„å¯¼èˆªå…ƒç´ ï¼Œé¿å…è¯¯åˆ å†…å®¹
                if (this.isNavigationElement(el)) {
                    console.debug('[ContentCleaner] Removing navigation element:', selector);
                    el.remove();
                }
            });
        });
    }

    /**
     * åˆ¤æ–­æ˜¯å¦æ˜¯å¯¼èˆªå…ƒç´ 
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @returns {boolean} æ˜¯å¦æ˜¯å¯¼èˆªå…ƒç´ 
     */
    isNavigationElement(element) {
        const text = element.textContent?.trim();

        // å¦‚æœåŒ…å«å¤§é‡æ–‡æœ¬å†…å®¹ï¼Œå¯èƒ½ä¸æ˜¯çº¯å¯¼èˆªå…ƒç´ 
        if (text && text.length > 200) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯¼èˆªç›¸å…³çš„å…³é”®è¯
        const navigationKeywords = [
            'é¦–é¡µ', 'ä¸»é¡µ', 'è¿”å›', 'ä¸Šä¸€é¡µ', 'ä¸‹ä¸€é¡µ', 'èœå•', 'å¯¼èˆª',
            'Home', 'Back', 'Next', 'Previous', 'Menu', 'Navigation',
            'ãƒ›ãƒ¼ãƒ ', 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼', 'ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³'
        ];

        return navigationKeywords.some(keyword => text?.includes(keyword));
    }

    /**
     * åº”ç”¨ç½‘ç«™ç‰¹å®šçš„æ¸…ç†è§„åˆ™
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @param {string} hostname - ç½‘ç«™åŸŸå
     * @returns {Promise<void>}
     */
    async applyCustomRules(element, hostname) {
        const rules = this.cleaningRules.get(hostname);

        if (rules && rules.length > 0) {
            console.debug(`[ContentCleaner] Applying ${rules.length} custom rules for ${hostname}`);

            for (const rule of rules) {
                try {
                    await rule(element);
                } catch (error) {
                    console.error(`[ContentCleaner] Custom rule failed for ${hostname}:`, error);
                }
            }
        }
    }

    /**
     * æ¸…ç†ç©ºå…ƒç´ 
     * @param {HTMLElement} element - DOMå…ƒç´ 
     */
    removeEmptyElements(element) {
        console.debug('[ContentCleaner] Removing empty elements');

        // å¤šæ¬¡æ¸…ç†ï¼Œå› ä¸ºç§»é™¤å…ƒç´ åå¯èƒ½äº§ç”Ÿæ–°çš„ç©ºå…ƒç´ 
        let removedCount = 0;
        let maxIterations = 5;

        for (let i = 0; i < maxIterations; i++) {
            const emptyElements = Array.from(element.querySelectorAll('*')).filter(el => {
                return this.isEmpty(el) && this.isSafeToRemove(el);
            });

            if (emptyElements.length === 0) {
                break;
            }

            emptyElements.forEach(el => {
                el.remove();
                removedCount++;
            });
        }

        if (removedCount > 0) {
            console.debug(`[ContentCleaner] Removed ${removedCount} empty elements`);
        }
    }

    /**
     * åˆ¤æ–­å…ƒç´ æ˜¯å¦ä¸ºç©º
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @returns {boolean} æ˜¯å¦ä¸ºç©º
     */
    isEmpty(element) {
        const text = element.textContent?.trim();
        const children = element.children;

        // æœ‰æ–‡æœ¬å†…å®¹åˆ™ä¸ä¸ºç©º
        if (text && text.length > 0) {
            return false;
        }

        // æœ‰å­å…ƒç´ åˆ™ä¸ä¸ºç©º
        if (children.length > 0) {
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰é‡è¦çš„å±æ€§ï¼ˆå¦‚å›¾ç‰‡çš„srcï¼‰
        if (element.tagName === 'IMG' && element.src) {
            return false;
        }

        return true;
    }

    /**
     * åˆ¤æ–­å…ƒç´ æ˜¯å¦å¯ä»¥å®‰å…¨ç§»é™¤
     * @param {HTMLElement} element - DOMå…ƒç´ 
     * @returns {boolean} æ˜¯å¦å¯ä»¥å®‰å…¨ç§»é™¤
     */
    isSafeToRemove(element) {
        // ä¸ç§»é™¤é‡è¦çš„ç»“æ„æ€§å…ƒç´ 
        const importantTags = ['html', 'head', 'body', 'main', 'article', 'section'];

        if (importantTags.includes(element.tagName.toLowerCase())) {
            return false;
        }

        // ä¸ç§»é™¤æœ‰é‡è¦å±æ€§çš„å…ƒç´ 
        if (element.id || element.hasAttribute('data-important')) {
            return false;
        }

        return true;
    }

    /**
     * æ³¨å†Œç½‘ç«™ç‰¹å®šçš„æ¸…ç†è§„åˆ™
     * @param {string} hostname - ç½‘ç«™åŸŸå
     * @param {Function} rule - æ¸…ç†è§„åˆ™å‡½æ•°
     */
    registerCleaningRule(hostname, rule) {
        if (!this.cleaningRules.has(hostname)) {
            this.cleaningRules.set(hostname, []);
        }

        this.cleaningRules.get(hostname).push(rule);
        console.debug(`[ContentCleaner] Registered cleaning rule for ${hostname}`);
    }

    /**
     * åˆå§‹åŒ–é»˜è®¤æ¸…ç†è§„åˆ™
     */
    initializeDefaultRules() {
        // ä¸ºç‰¹å®šç½‘ç«™æ³¨å†Œé»˜è®¤è§„åˆ™

        // Kimiç½‘ç«™ç‰¹å®šè§„åˆ™
        this.registerCleaningRule('www.kimi.com', (element) => {
            // ç§»é™¤Kimiç‰¹æœ‰çš„ç•Œé¢å…ƒç´ 
            element.querySelectorAll('.segment-generate-tip').forEach(el => el.remove());
            
            // åªåœ¨å¤åˆ¶åœºæ™¯ä¸‹ç§»é™¤æŒ‰é’®å®¹å™¨ï¼Œä¸åœ¨æ³¨å…¥åœºæ™¯ä¸‹ç§»é™¤
            if (this.cleaningForCopy) {
                element.querySelectorAll('.segment-assistant-actions').forEach(el => el.remove());
                console.debug('[ContentCleaner] Removed segment-assistant-actions in copy scenario');
            } else {
                console.debug('[ContentCleaner] Preserved segment-assistant-actions in injection scenario');
            }
        });

        // DeepSeekç½‘ç«™ç‰¹å®šè§„åˆ™
        this.registerCleaningRule('chat.deepseek.com', (element) => {
            // DeepSeeké€šå¸¸æœ‰è‰¯å¥½çš„HTMLç»“æ„ï¼Œä¸»è¦åšåŸºæœ¬æ¸…ç†
            element.querySelectorAll('[class*="action"], [class*="toolbar"]').forEach(el => el.remove());
        });

    }

    /**
     * æ¸…é™¤æ‰€æœ‰æ¸…ç†è§„åˆ™
     * ä¸»è¦ç”¨äºæµ‹è¯•
     */
    clearRules() {
        this.cleaningRules.clear();
        console.debug('[ContentCleaner] All cleaning rules cleared');
    }
}

// å¯¼å‡ºç±»
export { ContentCleaner };